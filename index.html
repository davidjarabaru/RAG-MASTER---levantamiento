<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Architect Suite v8.0 - RAG SCORING MASTER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Flowchart Custom Styles */
        .stage-connector { position: absolute; left: 28px; top: 60px; bottom: -30px; width: 3px; background: #e2e8f0; z-index: 0; }
        .stage-card:last-child .stage-connector { display: none; }
        
        /* Custom Colors for RAG */
        .bg-rag-dark { background-color: #1e293b; }
        .text-rag-blue { color: #00b8d4; }
        .border-rag-blue { border-color: #00b8d4; }
        .tab-active { border-left: 4px solid #00b8d4; background: #0f172a; color: white; }
        .tab-inactive { border-left: 4px solid transparent; color: #94a3b8; }
        .tab-inactive:hover { background: #1e293b; color: white; }

        .qa-step-card { border: 1px solid #e5e7eb; border-radius: 8px; margin-top: 10px; padding: 12px; background: #f9fafb; position: relative; }
        .qa-step-card:hover { border-color: #00b8d4; }

        .editable-table input {
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 4px 0;
            margin: 0;
        }

        @media print {
            .sidebar { display: none !important; }
            .main-content { margin: 0 !important; width: 100% !important; }
            .stage-card { break-inside: avoid; page-break-inside: avoid; border: 1px solid #ccc; margin-bottom: 20px; }
            textarea { border: none !important; }
            .text-rag-blue { color: #000 !important; }
            .editable-table input {
                padding: 0;
            }
        }

        /* Force visibility of action buttons (add/remove) so they're always visible */
        button,
        .no-print,
        .editable-table button,
        .qa-step-card button,
        .stage-card button {
            opacity: 1 !important;
            visibility: visible !important;
            transform: none !important;
            pointer-events: auto !important;
        }

        /* Stronger rules for delete/add controls: size, color, and stacking */
        .qa-step-card > button,
        .editable-table button,
        td button.text-red-400,
        .text-red-400 {
            display: inline-block !important;
            opacity: 1 !important;
            visibility: visible !important;
            color: #dc2626 !important; /* red-600 */
            background: transparent !important;
            border: none !important;
            font-size: 16px !important;
            line-height: 1 !important;
            padding: 2px 6px !important;
            margin: 0 !important;
            z-index: 50 !important;
        }

        /* Ensure small 'x' buttons in tables are obvious and clickable */
        table td button.text-red-400 {
            background: #fff !important;
            border-radius: 4px !important;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06) !important;
        }

        /* Visual styles for add/remove buttons to match example */
        .btn-visible-add {
            background: #059669 !important; /* emerald-600 */
            color: #ffffff !important;
            padding: 8px 12px !important;
            border-radius: 8px !important;
            box-shadow: 0 8px 20px rgba(2,6,23,0.12) !important;
            border: none !important;
            font-weight: 600 !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 8px !important;
        }
        .btn-visible-add:hover { background: #047857 !important; }

        .btn-visible-remove {
            background: #ffffff !important;
            color: #dc2626 !important;
            border: 1px solid rgba(220,38,38,0.12) !important;
            padding: 4px 8px !important;
            border-radius: 6px !important;
            font-weight: 700 !important;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans h-screen flex overflow-hidden">

    <aside class="sidebar w-72 bg-rag-dark text-white flex flex-col shadow-2xl z-20 transition-all">
        <div class="p-6 border-b border-slate-700 bg-slate-900">
            <h1 class="text-xl font-bold tracking-wide text-rag-blue"><i class="fa-solid fa-brain mr-2"></i>RAG<span class="font-light text-white">Master</span></h1>
            <p class="text-xs text-slate-400 mt-1 opacity-80">Arquitectura de Agente Conversacional v8.0</p>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-4 space-y-1">
            <button onclick="showSection('dashboard', event)" class="nav-btn tab-inactive w-full text-left px-6 py-4 transition-all flex items-center gap-3">
                <i class="fa-solid fa-chart-line w-5 text-center"></i> 1. Resumen & Persona
            </button>
            <button onclick="showSection('flow', event)" class="nav-btn tab-active w-full text-left px-6 py-4 transition-all flex items-center gap-3">
                <i class="fa-solid fa-road w-5 text-center"></i> 2. Flujo Q&A Detallado
            </button>
            <button onclick="showSection('entities', event)" class="nav-btn tab-inactive w-full text-left px-6 py-4 transition-all flex items-center gap-3">
                <i class="fa-solid fa-database w-5 text-center"></i> 3. Scoring por Entidad
            </button>
            <button onclick="showSection('rag-config', event)" class="nav-btn tab-inactive w-full text-left px-6 py-4 transition-all flex items-center gap-3">
                <i class="fa-solid fa-book-open w-5 text-center"></i> 4. Base de Conocimiento
            </button>
            <button onclick="showSection('qa-library', event)" class="nav-btn tab-inactive w-full text-left px-6 py-4 transition-all flex items-center gap-3">
                <i class="fa-solid fa-reply-all w-5 text-center"></i> 5. Librer√≠a Maestra Q&A
            </button>
            <button onclick="showSection('scoring', event)" class="nav-btn tab-inactive w-full text-left px-6 py-4 transition-all flex items-center gap-3">
                <i class="fa-solid fa-star-half-stroke w-5 text-center"></i> 6. Scoring Global (CPs)
            </button>
            <button onclick="showSection('export', event)" class="nav-btn tab-inactive w-full text-left px-6 py-4 transition-all flex items-center gap-3">
                <i class="fa-solid fa-file-code w-5 text-center"></i> 7. Exportar Config
            </button>
        </nav>
    </aside>

    <main class="main-content flex-1 overflow-y-auto relative bg-slate-50">
        
        <header class="sticky top-0 z-10 bg-white border-b border-slate-200 px-8 py-4 flex justify-between items-center shadow-sm">
            <div>
                <h2 id="page-title" class="text-2xl font-bold text-slate-800">Flujo Q&A Detallado</h2>
                <p id="page-subtitle" class="text-sm text-slate-500">Configuraci√≥n espec√≠fica para Flujo Q&A Detallado</p>
            </div>
            <div class="flex gap-3 no-print">
                <button onclick="window.print()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-medium border border-slate-300">
                    <i class="fa-solid fa-print mr-2"></i> Word / PDF
                </button>
                <button onclick="downloadJSON()" class="px-4 py-2 bg-rag-dark text-white rounded-lg text-sm font-medium hover:bg-slate-700 shadow-lg hover:shadow-xl transition-all">
                    <i class="fa-solid fa-download mr-2"></i> Generar JSON
                </button>
                    <button onclick="openNuevoRAG()" id="btn-nuevo-rag" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700 shadow-md btn-visible-add">
                        <i class="fa-solid fa-rocket mr-2"></i> Nuevo RAG
                    </button>
            </div>
        </header>

        <div class="p-8 max-w-7xl mx-auto pb-32">

            <!-- Nuevo RAG Modal / Wizard -->
            <div id="nuevo-rag-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
                <div class="bg-white rounded-xl w-11/12 md:w-3/4 lg:w-2/3 p-6 shadow-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Nuevo RAG ‚Äî Identif√≠cate</h3>
                        <button onclick="closeNuevoRAG()" class="text-slate-500 hover:text-slate-700">‚úï</button>
                    </div>
                    <div id="nuevo-rag-steps">
                        <div class="step" data-step="1">
                            <p class="text-sm text-slate-600 mb-3">Ingrese su nombre de usuario y el nombre del proyecto para habilitar la interfaz.</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-slate-600">Usuario</label>
                                    <input id="nr_user" type="text" class="w-full p-2 border rounded" placeholder="Ej: david" />
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-600">Proyecto</label>
                                    <input id="nr_project" type="text" class="w-full p-2 border rounded" placeholder="Ej: BYD-Implementacion" />
                                </div>
                            </div>
                        </div>

                        <div class="step hidden" data-step="2">
                            <h4 class="font-semibold">¬øQu√© es esto?</h4>
                            <p class="text-sm text-slate-600">Este asistente le guiar√° por los campos principales: Contexto, Etapas del Journey, Librer√≠a Q&A y Scoring. Cada paso incluye una breve explicaci√≥n de para qu√© sirve.</p>
                        </div>

                        <div class="step hidden" data-step="3">
                            <h4 class="font-semibold">Habilitar campos</h4>
                            <p class="text-sm text-slate-600">Al finalizar se habilitar√°n todos los campos de la interfaz para que pueda comenzar a editar.</p>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-between">
                        <div>
                            <button id="nr-prev" onclick="prevWizardStep()" class="px-3 py-2 rounded bg-slate-100 text-slate-700 hidden">Anterior</button>
                        </div>
                        <div class="flex gap-2">
                            <button id="nr-next" onclick="nextWizardStep()" class="px-4 py-2 rounded bg-emerald-600 text-white">Siguiente</button>
                            <button id="nr-skip" onclick="finishWizard(true)" class="px-4 py-2 rounded bg-slate-200 text-slate-700">Saltar</button>
                        </div>
                    </div>
                </div>
            </div>


            <div id="dashboard" class="section-panel space-y-8 hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-lg border-b pb-2 mb-4">Contexto y Persona General</h3>
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Empresa / Producto</label>
                            <input type="text" id="clientName" class="w-full p-2 border rounded focus:ring-2 focus:ring-rag-blue outline-none" placeholder="Ej: Venta de autos el√©ctricos BYD">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-1">Nombre y Rol del Agente</label>
                            <input type="text" id="agentName" class="w-full p-2 border rounded focus:ring-2 focus:ring-rag-blue outline-none" value="Sof√≠a, Agente Setter" placeholder="Ej: Sof√≠a, Asesora Virtual">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-slate-600 mb-1">System Prompt Base (Tonalidad y Reglas de Comportamiento)</label>
                            <textarea id="basePrompt" rows="4" class="w-full p-3 border rounded text-sm font-mono bg-slate-50 focus:bg-white focus:ring-2 focus:ring-rag-blue outline-none" placeholder="Define aqu√≠ el tono, l√≠mites √©ticos y objetivos macro..."></textarea>
                        </div>
                    </div>
                    <!-- Bot√≥n gen√©rico de ejemplo, aunque esta secci√≥n es de inputs -->
                    <div class="mt-6 text-right no-print">
                        <button class="px-4 py-2 text-slate-600 bg-slate-100 rounded-lg text-sm font-medium border border-slate-300 hover:bg-slate-200" disabled>
                            <i class="fa-solid fa-info-circle mr-2"></i> No se requieren m√°s botones aqu√≠
                        </button>
                    </div>
                </div>
            </div>

            <div id="flow" class="section-panel">
                <div class="mb-6 flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold text-slate-800">Mapa del Journey y Q&A de Camino Cr√≠tico</h3>
                        <p class="text-sm text-slate-500">Define el rol y los pasos conversacionales exactos para la **ruta feliz**. **Cada secci√≥n de Q&A se puede expandir y contraer din√°micamente.**</p>
                    </div>
                    <button onclick="addStage()" class="text-sm bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 shadow-md no-print btn-visible-add">
                        <i class="fa-solid fa-layer-group mr-1"></i> A√±adir Nueva Etapa (Stage)
                    </button>
                </div>

                <div id="flow-container" class="space-y-0 pl-6 pb-20">
                    <!-- Flow content rendered by JS -->
                </div>
            </div>

            <div id="entities" class="section-panel hidden">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-800">Mapeo de Entidades y Scoring por Entidad</h3>
                        <!-- Bot√≥n para a√±adir Entidad (Secci√≥n 3) -->
                        <button onclick="addEntityRow()" class="text-sm bg-rag-blue text-white px-3 py-1 rounded hover:bg-cyan-600 no-print btn-visible-add">
                            <i class="fa-solid fa-plus mr-1"></i> Agregar Variable
                        </button>
                    </div>
                    <p class="text-sm text-slate-500 mb-4">Puntuaci√≥n asignada al lead por la **calidad del dato capturado**. Todo editable y din√°mico.</p>

                    <table class="w-full text-left border-collapse" id="entitiesTable">
                        <thead>
                            <tr class="bg-slate-50 text-xs text-slate-500 uppercase">
                                <th class="p-3 border-b">Entidad (JSON Key)</th>
                                <th class="p-3 border-b">Tipo de Dato</th>
                                <th class="p-3 border-b">Condici√≥n/Validaci√≥n</th>
                                <th class="p-3 border-b text-center">Score Asignado</th>
                                <th class="p-3 border-b w-10">Requerido en</th>
                                <th class="p-3 border-b w-10"></th>
                            </tr>
                        </thead>
                        <tbody class="text-sm">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="rag-config" class="section-panel hidden space-y-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Instrucciones Espec√≠ficas del M√≥dulo RAG</h3>
                    <label class="block text-sm font-medium text-slate-600 mb-1">RAG System Prompt Adicional</label>
                    <textarea id="ragPrompt" rows="4" class="w-full p-3 border rounded text-sm font-mono bg-slate-900 text-green-400 focus:outline-none" placeholder="Instrucciones para el motor de respuestas."></textarea>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-800">Fuentes de Conocimiento (RAG Sources)</h3>
                        <!-- Bot√≥n para a√±adir Fuente (Subsecci√≥n de Secci√≥n 4) -->
                        <button onclick="addSourceRow()" class="text-sm bg-rag-blue text-white px-3 py-1 rounded hover:bg-cyan-600 no-print btn-visible-add">
                            <i class="fa-solid fa-plus mr-1"></i> Agregar Fuente
                        </button>
                    </div>
                    <table class="w-full text-left border-collapse" id="sourcesTable">
                        <thead>
                            <tr class="bg-slate-50 text-xs text-slate-500 uppercase">
                                <th class="p-3 border-b">Nombre Fuente</th>
                                <th class="p-3 border-b">Tipo / URL</th>
                                <th class="p-3 border-b">Prioridad</th>
                                <th class="p-3 border-b w-10"></th>
                            </tr>
                        </thead>
                        <tbody class="text-sm">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="qa-library" class="section-panel hidden space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-800">Librer√≠a Maestra de Q&A y Scoring de Respuestas</h3>
                        <!-- Bot√≥n para a√±adir Patr√≥n Q&A (Secci√≥n 5) -->
                        <button onclick="addQALibraryRow()" class="text-sm bg-rag-blue text-white px-3 py-1 rounded hover:bg-cyan-600 no-print btn-visible-add">
                            <i class="fa-solid fa-plus mr-1"></i> Agregar Patr√≥n Q&A
                        </button>
                    </div>
                    <p class="text-sm text-slate-500 mb-4">Define patrones de preguntas, respuestas esperadas y el puntaje que otorgan por una **respuesta de alta calidad** del cliente. **Todo editable y din√°mico.**</p>

                    <table class="w-full text-left border-collapse" id="qaLibraryTable">
                        <thead>
                            <tr class="bg-slate-50 text-xs text-slate-500 uppercase">
                                <th class="p-3 border-b w-1/4">Pregunta del Agente (Input)</th>
                                <th class="p-3 border-b w-1/4">Respuesta/Intenci√≥n Esperada del Cliente</th>
                                <th class="p-3 border-b w-1/6 text-center">Score de Respuesta</th>
                                <th class="p-3 border-b w-1/6">Asignaci√≥n de Etapa/Rol</th>
                                <th class="p-3 border-b w-10"></th>
                            </tr>
                        </thead>
                        <tbody class="text-sm">
                            </tbody>
                    </table>
                </div>
            </div>


            <div id="scoring" class="section-panel hidden space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-800">Matriz de Checkpoints (Scoring Global)</h3>
                        <!-- Bot√≥n para a√±adir Checkpoint (Secci√≥n 6) -->
                        <button onclick="addScoringRow()" class="text-sm bg-rag-blue text-white px-3 py-1 rounded hover:bg-cyan-600 no-print btn-visible-add">
                            <i class="fa-solid fa-plus mr-1"></i> Agregar Checkpoint
                        </button>
                    </div>
                    <p class="text-sm text-slate-500 mb-6">El **Score Total** es la suma de: **Score de Entidad** + **Score de Respuesta** + **Score Global (CP)**. Los CP son hitos l√≥gicos del flujo.</p>

                    <table class="w-full text-left border-collapse" id="scoringTable">
                        <thead>
                            <tr class="bg-slate-50 text-xs text-slate-500 uppercase">
                                <th class="p-4 border-b">ID</th>
                                <th class="p-4 border-b">Criterio / Hito</th>
                                <th class="p-4 border-b">Etapa</th>
                                <th class="p-4 border-b text-right">Score Asignado</th>
                                <th class="p-4 border-b w-10"></th>
                            </tr>
                        </thead>
                        <tbody class="text-sm divide-y divide-slate-100" id="scoring-tbody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="export" class="section-panel hidden">
                <div class="bg-slate-800 text-white p-8 rounded-xl shadow-2xl">
                    <h3 class="text-xl font-bold mb-2">JSON T√©cnico Final</h3>
                    <p class="text-slate-400 text-sm mb-6">Contiene toda la estructura del flujo, RAG, y reglas para el desarrollador.</p>
                    
                    <div class="bg-black bg-opacity-30 p-4 rounded-lg font-mono text-xs text-green-400 mb-6 overflow-x-auto border border-slate-700 h-64" id="json-preview">
                        // JSON Preview will appear here
                    </div>

                    <button onclick="downloadJSON()" class="w-full py-3 bg-rag-blue hover:bg-cyan-500 rounded-lg font-bold transition flex justify-center items-center gap-2">
                        <i class="fa-solid fa-file-export"></i> DESCARGAR .JSON
                    </button>
                </div>
            </div>
        </div>
    </main>

<script>
    // --- DEFAULT DATA MODELS (ACTUALIZADOS CON INFO DEL WORD) ---
    
    // Global Checkpoints (Scoring Global)
    let checkpoints = [
        { id: "CP1", desc: "Captura celular / Nombre", stage: "E1", score: 10 },
        { id: "CP2", desc: "Valida si es lead viable (S√ç interesado)", stage: "E1", score: 20 },
        { id: "CP3", desc: "Confirma inter√©s en producto / Indagaci√≥n inicial", stage: "E2", score: 30 },
        { id: "CP4", desc: "Detecta intenci√≥n temprana de prueba o compra", stage: "E2", score: 40 },
        { id: "CP5", desc: "Confirma intenci√≥n de Test Drive (Pasa a E3)", stage: "E2", score: 50 },
        { id: "CP6", desc: "Confirmar Datos Cita (Fecha/Hora/Sucursal)", stage: "E3", score: 60 },
        { id: "CP7", desc: "Consolida y agenda la reuni√≥n", stage: "E3", score: 70 },
        { id: "CP8", desc: "CITA CONFIRMADA ‚Üí HANDOFF SDR (Hito Final)", stage: "E3", score: 100 }
    ];

    // CRM Entities (Scoring por Entidad)
    let entities = [
        { key: "customer_name", type: "String", validation: "No vac√≠o", score: 5, required_in: "E1" },
        { key: "phone", type: "Number", validation: "Formato v√°lido", score: 5, required_in: "E1" },
        { key: "product_model", type: "String", validation: "Modelo BYD v√°lido", score: 10, required_in: "E1" },
        { key: "use_case", type: "String", validation: "Ciudad, Carretera o Ambos", score: 10, required_in: "E2" },
        { key: "appointment_day", type: "String", validation: "Entre semana/Fin de semana", score: 10, required_in: "E3" },
        { key: "appointment_time", type: "String", validation: "Ma√±ana/Tarde", score: 10, required_in: "E3" },
        { key: "appointment_location", type: "String", validation: "Sucursal v√°lida", score: 10, required_in: "E3" },
    ];

    // RAG Sources
    let sources = [
        { name: "Inventario BYD JSON", type: "JSON", url: "/api/products", priority: "Alta" },
        { name: "Manual de Pol√≠ticas", type: "PDF", url: "drive://docs/manual.pdf", priority: "Media" },
    ];
    
    // Global Q&A Library (Scoring por Respuesta)
    let qaLibrary = [
        { q: "Pregunta 1-2: Indagaci√≥n de Necesidades", a: "Detecta perfil (uso, familia)", score: 15, stage: "E2" },
        { q: "¬øTe gustar√≠a agendar una prueba de manejo?", a: "Respuesta 'SI' o 'MUY CALIENTE'", score: 10, stage: "E2" }
    ];
    
    // Base de Conocimientos R√°pida de Modelos (Secci√≥n V del Word)
    let productKnowledge = [
        { model: "SEAGULL", autonomia: "300-400 km", potencia: "74 HP", usp: "Ahorra $760/a√±o ‚Ä¢ Pantalla giratoria 10.1\" ‚Ä¢ NFC", perfil: "Urbano econ√≥mico, bajo presupuesto" },
        { model: "DOLPHIN", autonomia: "405 km", potencia: "93 HP", usp: "Torque 180 Nm ‚Ä¢ Audio Dirac ‚Ä¢ Karaoke", perfil: "Juvenil din√°mico, Millennials" },
        { model: "YUAN PRO", autonomia: "380 km", potencia: "174 HP", usp: "Ahorra $500/a√±o ‚Ä¢ 58% m√°s HP ‚Ä¢ Frenado IPBS", perfil: "SUV accesible, Familias peque√±as" },
        { model: "YUAN PLUS", autonomia: "410-480 km", potencia: "201 HP", usp: "Ahorra $1,050/a√±o ‚Ä¢ \"Hi BYD\" voz ‚Ä¢ DiPilot", perfil: "SUV bestseller, Familias" },
        { model: "SONG PLUS", autonomia: "1,105 km", potencia: "337 HP", usp: "H√≠brido sin ansiedad ‚Ä¢ Audio Infinity ‚Ä¢ ADAS 22 sistemas", perfil: "H√≠brido familiar, viajes largos" },
        { model: "SHARK", autonomia: "840 km", potencia: "430 HP", usp: "Pickup DMO offroad ‚Ä¢ 650 Nm ‚Ä¢ 8 Airbags", perfil: "Pickup trabajo, Empresarios, aventura offroad" },
        { model: "SEALION 7", autonomia: "456 km", potencia: "522 HP", usp: "0-100 en 4.5s ‚Ä¢ Carga 230 kW ‚Ä¢ Dynaudio 12", perfil: "Deportivo tech, entusiastas" },
        { model: "TANG EV", autonomia: "635 km", potencia: "509 HP", usp: "7 asientos ‚Ä¢ AWD ‚Ä¢ Frenos Brembo", perfil: "SUV premium 7, Familias grandes, lujo" },
        { model: "HAN EV", autonomia: "602 km", potencia: "510 HP", usp: "0-100 en 3.9s ‚Ä¢ El m√°s r√°pido ‚Ä¢ Semi-aut√≥nomo", perfil: "Sed√°n ejecutivo" }
    ];


    // Stage Templates (ACTUALIZADOS CON INFO DEL WORD - INCLUYE TIEMPO M√ÅXIMO, ALCANCE, OBJETIVO, BASE DE DATOS)
    const stages = [
        {
            id: 1,
            code: "E1",
            title: "Apertura & Captura Inicial",
            role: "Comercial Nivel 1 (Validador)",
            color: "blue",
            kpi: "MQL: 10 ‚Üí 20",
            time_limit: "30 seg - 1 min", 
            scope: "Primer contacto + Filtro de validez", // Nuevo campo
            objective: "Atenci√≥n hot lead - Validar inter√©s real", // Nuevo campo
            database: "Supabase", // Nuevo campo
            prompt: `Eres el Agente Comercial Nivel 1 (Validador). Tu objetivo es la Atenci√≥n hot lead, filtrar leads inv√°lidos y capturar Nombre/Tel√©fono, pasando de MQL 10 a 20.`,
            context_notes: `Contexto de Entrada:\n- El lead llega desde un anuncio de Meta/Facebook.\n- Producto de inter√©s: El modelo BYD del anuncio.\n- Canal: WhatsApp.\n- NO conocemos: Nombre del lead.`,
            qa_steps: [
                { q: "¬°Hola! üëã Soy de BYD. Vi que te interes√≥ el [MODELO]. ¬°Excelente elecci√≥n! ¬øTe gustar√≠a conocer m√°s sobre este veh√≠culo?", a: "Respuesta 'SI' (V√ÅLIDO) o 'NO' (NO_V√ÅLIDO)", entities_to_capture: ["product_model"], cp_trigger: "CP2" },
                { q: "¬°Genial! Para brindarte mejor informaci√≥n, ¬øcon qui√©n tengo el gusto?", a: "Nombre y Tel√©fono (Formato v√°lido)", entities_to_capture: ["customer_name", "phone"], cp_trigger: "CP1" }
            ]
            ,
            custom_fields: []
        },
        {
            id: 2,
            code: "E2",
            title: "Desarrollo & Consultor√≠a (RAG Core)",
            role: "Comercial Nivel 2 (Consultor)",
            color: "purple",
            kpi: "MQL: 30 ‚Üí 40 ‚Üí 50",
            time_limit: "2 - 5 min",
            scope: "Filtrar y Calificar lead MQL", // Nuevo campo
            objective: "Filtrar y Calificar el lead MQL (Score 20 a 50) usando la Base de Conocimiento (RAG)", // Nuevo campo
            database: "Supabase", // Nuevo campo
            prompt: `Eres el Agente Comercial Nivel 2 (Consultor). Tu objetivo es Filtrar y Calificar el lead MQL (Score 20 a 50) usando la Base de Conocimiento (RAG) con la f√≥rmula VALOR + CONTEXTO + PREGUNTA. M√°ximo 3-5 intercambios antes de proponer cita (CP5).`,
            rag_config: { 
                pre_condition: "Score MQL > 20 (Validado en E1)", 
                strategy: "Semantic Search, Max Chunks: 3, Temp: 0.2",
            },
            context_notes: `Regla de Oro: M√°ximo 3-5 preguntas. Despu√©s de 3-5 intercambios, ofrecer Test Drive.\n\nContexto de Entrada:\n- Lead validado de Parte 1.\n- Ya conocemos: Nombre, Producto de inter√©s, Score actual MQL 20.`,
            formula_humana: [
                { elemento: "1. VALOR", que_es: "Respuesta directa a su pregunta", ejemplo: "\"Tiene 405 km de autonom√≠a\"" },
                { elemento: "2. CONTEXTO", que_es: "Traducir el dato a su vida real", ejemplo: "\"Ida y vuelta Quito-Otavalo sin problema\"" },
                { elemento: "3. PREGUNTA", que_es: "Indagar m√°s sobre SU necesidad", ejemplo: "\"¬øHar√≠as viajes largos seguido?\"" }
            ],
            ejemplo_comparacion: `Comparaci√≥n (Ejemplo de Respuesta Humana vs Bot):\nPregunta: "¬øQu√© autonom√≠a tiene?"\n‚ùå Respuesta Bot: "405 km. ¬øAgendamos cita?"\n‚úÖ Respuesta Humana: "405 km con una carga. ¬øLo usar√≠as m√°s para ciudad o tambi√©n carretera?"`,
            senales_compra: [
                { senal: "Hace preguntas de indagaci√≥n b√°sica", nivel: "TIBIO ‚Üí Seguir conversando" },
                { senal: "\"Me interesa\" / \"Suena bien\" / \"Est√° bueno\"", nivel: "CALIENTE ‚Üí Proponer cita suavemente" },
                { senal: "¬øD√≥nde lo puedo ver? / ¬øTienen para probar?", nivel: "MUY CALIENTE ‚Üí Agendar directo" },
                { senal: "Pregunta t√©cnica detallada (kWh, motor, carga DC)", nivel: "üî• EXPERTO INTERESADO ‚Üí Responder + Agendar" }
            ],
            scripts_transicion: `Scripts de Transici√≥n Natural (Despu√©s de 3-4 intercambios):\n* Suave: "¬øSabes qu√©? Creo que la mejor forma de resolver todas tus dudas es vi√©ndolo en persona. ¬øQu√© te parece?"\n* Directa: "Mira, te lo digo de frente: manejarlo es otra cosa. ¬øTe animas a probarlo un d√≠a de estos?"\n* Manejo de Cliente Experto: Reconocer su conocimiento ("Veo que ya investigaste bien...") ‚Üí Dar dato t√©cnico preciso ‚Üí Invitar a experimentar.`,
            qa_steps: [
                { q: "¬øPara qu√© uso ser√≠a principalmente? ¬øCiudad, carretera, o ambos?", a: "Detectar perfil (Indagaci√≥n de Necesidades)", entities_to_capture: ["use_case"], cp_trigger: "CP3" },
                { q: "Responde Duda Principal del Cliente con VALOR+CONTEXTO+PREGUNTA.", a: "Confirmaci√≥n de inter√©s (TIBIO/CALIENTE)", entities_to_capture: [], cp_trigger: "CP4" },
                { q: "Transici√≥n a Cita: ¬øTe gustar√≠a agendar un Test Drive?", a: "Intenci√≥n de agendar (SI/MUY CALIENTE)", entities_to_capture: [], cp_trigger: "CP5" }
            ]
            ,
            custom_fields: []
        },
        {
            id: 3,
            code: "E3",
            title: "Cierre & Agendamiento",
            role: "Comercial Nivel 3 (Agendador)",
            color: "green",
            kpi: "SQL: 60 ‚Üí 70 ‚Üí 100",
            time_limit: "1 - 2 min",
            scope: "Generar SQL nivel 1 (Cita Confirmada)", // Nuevo campo
            objective: "Capturar la Fecha, Hora y Sucursal para generar el SQL nivel 1 y hacer Handoff", // Nuevo campo
            database: "Supabase", // Nuevo campo
            prompt: `Eres el Coordinador de Agenda. El CLIENTE YA QUIERE EL TEST DRIVE (CP5). Tu √∫nico objetivo es capturar la Fecha, Hora y Sucursal para generar el SQL nivel 1 y hacer Handoff. NO VENDES.`,
            context_notes: `Importante: Este agente NO vende. Solo agenda. El cliente YA acept√≥ el Test Drive.`,
            confirmacion_final_template: `Confirmaci√≥n Final (Template):\n¬°Listo [NOMBRE]! Queda agendado tu Test Drive del [MODELO] para el [D√çA] a las [HORA] en [SUCURSAL]. Te llegar√° confirmaci√≥n por WhatsApp. ¬°Nos vemos!`,
            datos_supabase: `Datos a Guardar en Supabase:\n- fecha_cita\n- hora_cita\n- sucursal\n- score: 60 (datos) ‚Üí 70 (agendado) ‚Üí 100 (confirmado)\n- stage: 'E3_AGENDADO'`,
            qa_steps: [
                { q: "¬°Excelente! Vamos a agendar tu Test Drive. ¬øQu√© d√≠a te queda mejor, entre semana o fin de semana?", a: "D√≠a de Cita", entities_to_capture: ["appointment_day"], cp_trigger: "CP6" },
                { q: "¬øPrefieres en la ma√±ana o en la tarde?", a: "Horario de Cita", entities_to_capture: ["appointment_time"], cp_trigger: "CP6" },
                { q: "¬øCu√°l sucursal te queda m√°s cerca? Tenemos en [LISTA]", a: "Ubicaci√≥n Sucursal", entities_to_capture: ["appointment_location"], cp_trigger: "CP7" },
                { q: "Confirmaci√≥n final: Queda agendado para [D√çA] a las [HORA] en [SUCURSAL]. ¬°Nos vemos!", a: "Cliente Confirma y Finaliza", entities_to_capture: [], cp_trigger: "CP8" }
            ]
            ,
            custom_fields: []
        }
    ];

    // --- RENDER FUNCTIONS ---
    
    // Renders a generic table from an array of objects
    function renderEditableTable(data, tableId, headers, columnKeys) {
        if (!data || data.length === 0) return `<p class="text-sm text-slate-500 italic">No hay datos en esta tabla.</p>`;
        
        const thead = `
            <thead>
                <tr class="bg-slate-50 text-xs text-slate-500 uppercase">
                    ${headers.map(h => `<th class="p-2 border-b">${h}</th>`).join('')}
                    <th class="p-2 border-b w-10"></th>
                </tr>
            </thead>
        `;
        
        const tbody = data.map((row, rowIndex) => `
            <tr id="${tableId}-row-${rowIndex}">
                ${columnKeys.map(key => `
                    <td class="p-2 border-b">
                        <input type="text" value="${row[key] || ''}" class="w-full text-sm outline-none">
                    </td>
                `).join('')}
                <td class="p-2 border-b">
                    <button class="text-red-400 hover:text-red-600 text-lg no-print btn-visible-remove" onclick="this.closest('tr').remove()">√ó</button>
                </td>
            </tr>
        `).join('');

        const addButton = `
            <tr>
                <td colspan="${headers.length + 1}" class="pt-3 text-center no-print">
                    <button class="text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded hover:bg-slate-300 btn-visible-add" onclick="addRowToEditableTable('${tableId}', [${columnKeys.map(k => `''`).join(',')}], [${columnKeys.map(k => `'${k}'`).join(',')}])">
                        <i class="fa-solid fa-plus mr-1"></i> A√±adir Fila
                    </button>
                </td>
            </tr>
        `;

        return `<table class="w-full text-left border-collapse editable-table">${thead}<tbody>${tbody}</tbody><tfoot>${addButton}</tfoot></table>`;
    }

    // Function to dynamically add a row to any editable table
    function addRowToEditableTable(tableId, defaultValues, columnKeys) {
        const tbody = document.querySelector(`#${tableId} tbody`);
        const newRow = document.createElement('tr');
        const rowIndex = Date.now(); // Unique key for the row
        newRow.id = `${tableId}-row-${rowIndex}`;

        let html = '';
        defaultValues.forEach((val, index) => {
            html += `<td class="p-2 border-b"><input type="text" value="${val}" class="w-full text-sm outline-none"></td>`;
        });
        html += `<td class="p-2 border-b"><button class="text-red-400 hover:text-red-600 text-lg no-print btn-visible-remove" onclick="this.closest('tr').remove()">√ó</button></td>`;
        
        newRow.innerHTML = html;
        tbody.appendChild(newRow);
    }
    
    // Function to add a Q&A step inside a Flow Stage
    function addQAStep(stageCode, q='', a='', entities='', cp='') {
        const container = document.getElementById(`qa-container-${stageCode}`);
        const newStep = document.createElement('div');
        newStep.className = 'qa-step-card';
        newStep.innerHTML = `
            <button class="absolute top-2 right-2 text-red-500 hover:text-red-700 text-sm no-print btn-visible-remove" onclick="this.closest('.qa-step-card').remove()">
                <i class="fa-solid fa-times"></i>
            </button>
            <div class="grid grid-cols-3 gap-3">
                <div class="col-span-3">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pregunta del Agente (Editable)</label>
                    <input type="text" class="w-full p-2 text-sm border rounded" placeholder="Ej: ¬øCu√°l es tu presupuesto?" value="${q}">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Respuesta Esperada / Intenci√≥n</label>
                    <input type="text" class="w-full p-2 text-sm border rounded" value="${a}" placeholder="Ej: {budget_range} capturado">
                </div>
                <div>
                    <label class="block text-xs font-bold text-blue-600 uppercase mb-1">Entidades a Capturar (Separar con coma)</label>
                    <input type="text" class="w-full p-2 text-sm border rounded" value="${entities}" placeholder="Ej: budget_range, timeline">
                </div>
                <div>
                    <label class="block text-xs font-bold text-green-600 uppercase mb-1">Activa Checkpoint (CP)</label>
                    <input type="text" class="w-full p-2 text-sm border rounded bg-green-50" value="${cp}" placeholder="Ej: CP3">
                </div>
            </div>
        `;
        container.appendChild(newStep);
    }

    // Add a custom metadata field to a stage (Section 2)
    function addCustomFieldToStage(stageCode) {
        const label = prompt('Etiqueta del nuevo campo (ej: "Sub-Objetivo")');
        if (!label) return;
        const key = 'cf_' + Date.now();
        const stage = stages.find(s => s.code === stageCode);
        if (!stage) return;
        if (!stage.custom_fields) stage.custom_fields = [];
        stage.custom_fields.push({ key: key, label: label, value: '', placeholder: '' });
        renderFlow();
        setTimeout(() => { const el = document.getElementById(`stage-${stageCode}`); if (el) el.scrollIntoView({ behavior: 'smooth' }); }, 120);
    }

    function renderFlow() {
        const container = document.getElementById('flow-container');
        container.innerHTML = stages.map(s => {
            let extraContent = '';

            // Metadata Block (Alcance, Objetivo, Base de Datos)
            const metadataBlock = `
                <div class="mt-4 p-3 bg-slate-50 rounded-lg border border-slate-200 grid grid-cols-3 gap-3 text-sm">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">1. Alcance / Scopo</label>
                        <input type="text" value="${s.scope || ''}" class="w-full p-1 text-sm rounded bg-white border" id="scope-${s.code}">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">2. Objetivo Principal</label>
                        <input type="text" value="${s.objective || ''}" class="w-full p-1 text-sm rounded bg-white border" id="objective-${s.code}">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">3. Base de Datos</label>
                        <input type="text" value="${s.database || 'N/A'}" class="w-full p-1 text-sm rounded bg-white border" id="database-${s.code}">
                    </div>

                    <div class="col-span-3 mt-3">
                        <div id="custom-fields-${s.code}" class="space-y-2">
                            ${(s.custom_fields || []).map((f, idx) => `
                                <div class="grid grid-cols-6 gap-2 items-center">
                                    <div class="col-span-2 text-xs text-slate-600 font-medium">${f.label}</div>
                                    <div class="col-span-4"><input id="custom-${s.code}-${f.key}" type="text" value="${f.value||''}" class="w-full p-1 text-sm rounded bg-white border custom-field-input" placeholder="${f.placeholder||''}"></div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-2 text-right">
                            <button class="text-xs bg-slate-200 text-slate-700 px-2 py-1 rounded btn-visible-add" onclick="addCustomFieldToStage('${s.code}')">A√±adir Campo</button>
                        </div>
                    </div>
                </div>
            `;
            
            // E1 Content: Context Notes
            if (s.code === 'E1' && s.context_notes) {
                extraContent += `
                    <div class="mt-4 border-t pt-4">
                        <h5 class="text-sm font-bold text-slate-700">Contexto de Entrada (Editable)</h5>
                        <textarea class="w-full p-3 text-sm border rounded-lg bg-slate-50 focus:ring-2 focus:ring-rag-blue outline-none font-mono text-slate-700 h-24 resize-none leading-relaxed" id="context-notes-${s.code}">${s.context_notes}</textarea>
                    </div>
                `;
            }

            // E2 Content: All the strategic details
            if (s.code === 'E2') {
                // RAG Config Block (Already Exists)
                const ragConfigBlock = s.rag_config ? `
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 space-y-3">
                        <h5 class="text-sm font-bold text-blue-700"><i class="fa-solid fa-code-branch mr-1"></i> CONFIGURACI√ìN RAG</h5>
                        <label class="block text-xs font-bold text-blue-600 uppercase">‚ö†Ô∏è Pre-Condici√≥n RAG</label>
                        <input type="text" class="w-full p-2 text-sm border rounded" placeholder="Ej: Scoring Entidad > 40" id="rag-precondition-${s.code}" value="${s.rag_config.pre_condition}">
                        <label class="block text-xs font-bold text-blue-600 uppercase mt-2">‚öôÔ∏è Estrategia de Consulta</label>
                        <input type="text" class="w-full p-2 text-sm border rounded" placeholder="Ej: Semantic Search, Max Chunks: 3, Temp: 0.2" id="rag-strategy-${s.code}" value="${s.rag_config.strategy}">
                    </div>
                ` : '';

                extraContent += ragConfigBlock;

                // Context Notes (Regla de Oro, etc.)
                if (s.context_notes) {
                    extraContent += `
                        <div class="mt-4 border-t pt-4">
                            <h5 class="text-sm font-bold text-slate-700">Reglas y Contexto (Editable)</h5>
                            <textarea class="w-full p-3 text-sm border rounded-lg bg-slate-50 focus:ring-2 focus:ring-rag-blue outline-none font-mono text-slate-700 h-24 resize-none leading-relaxed" id="context-notes-${s.code}">${s.context_notes}</textarea>
                        </div>
                    `;
                }
                
                // F√≥rmula Humana Table
                if (s.formula_humana) {
                    extraContent += `
                        <div class="mt-6">
                            <h5 class="text-sm font-bold text-purple-700 mb-2"><i class="fa-solid fa-vial-circle-check mr-1"></i> T√©cnica de Respuesta Conversacional (F√≥rmula Humana)</h5>
                            ${renderEditableTable(s.formula_humana, `formula-humana-table`, ['Elemento', 'Qu√© Es', 'Ejemplo'], ['elemento', 'que_es', 'ejemplo'])}
                            <textarea class="w-full p-3 text-sm border rounded-lg bg-slate-100 mt-3 resize-none leading-relaxed" id="ejemplo-comparacion">${s.ejemplo_comparacion}</textarea>
                        </div>
                    `;
                }
                
                // Se√±ales de Compra Table
                if (s.senales_compra) {
                    extraContent += `
                        <div class="mt-6">
                            <h5 class="text-sm font-bold text-orange-700 mb-2"><i class="fa-solid fa-fire mr-1"></i> Se√±ales de Compra (Cu√°ndo Transicionar)</h5>
                            ${renderEditableTable(s.senales_compra, `senales-compra-table`, ['Se√±al del Cliente', 'Nivel / Acci√≥n'], ['senal', 'nivel'])}
                        </div>
                    `;
                }

                // Scripts Transici√≥n
                if (s.scripts_transicion) {
                    extraContent += `
                        <div class="mt-6">
                            <h5 class="text-sm font-bold text-slate-700 mb-2"><i class="fa-solid fa-script mr-1"></i> Scripts de Transici√≥n y Manejo de Experto</h5>
                            <textarea class="w-full p-3 text-sm border rounded-lg bg-slate-50 focus:ring-2 focus:ring-rag-blue outline-none font-mono text-slate-700 h-40 resize-none leading-relaxed" id="scripts-transicion">${s.scripts_transicion}</textarea>
                        </div>
                    `;
                }

                // Product Knowledge Table (Base de Conocimientos R√°pida de Modelos)
                extraContent += `
                    <div class="mt-8 bg-white p-4 rounded-xl shadow-inner border border-slate-200">
                        <h5 class="text-sm font-bold text-rag-blue mb-2"><i class="fa-solid fa-car-side mr-1"></i> Base de Conocimientos R√°pida de Modelos (Referencia E2)</h5>
                        ${renderEditableTable(productKnowledge, `product-knowledge-table`, ['Modelo', 'Autonom√≠a', 'Potencia', 'USP Clave', 'Perfil Ideal'], ['model', 'autonomia', 'potencia', 'usp', 'perfil'])}
                    </div>
                `;
            }

            // E3 Content: Agendamiento Details
            if (s.code === 'E3') {
                // Context Notes (Importante)
                if (s.context_notes) {
                    extraContent += `
                        <div class="mt-4 border-t pt-4">
                            <h5 class="text-sm font-bold text-red-600">‚ö†Ô∏è Nota Importante del Rol (Editable)</h5>
                            <textarea class="w-full p-3 text-sm border rounded-lg bg-red-50 focus:ring-2 focus:ring-red-400 outline-none font-mono text-red-700 h-16 resize-none leading-relaxed" id="context-notes-${s.code}">${s.context_notes}</textarea>
                        </div>
                    `;
                }

                // Confirmation Template and Supabase Data
                if (s.confirmacion_final_template || s.datos_supabase) {
                    extraContent += `
                        <div class="mt-6 grid grid-cols-2 gap-4">
                            <div>
                                <h5 class="text-sm font-bold text-green-700 mb-2"><i class="fa-solid fa-list-check mr-1"></i> Template de Confirmaci√≥n Final (Editable)</h5>
                                <textarea class="w-full p-3 text-sm border rounded-lg bg-slate-50 font-mono text-slate-700 h-24 resize-none" id="confirmacion-final-template">${s.confirmacion_final_template}</textarea>
                            </div>
                            <div>
                                <h5 class="text-sm font-bold text-slate-700 mb-2"><i class="fa-solid fa-database mr-1"></i> Datos a Guardar en DB (Editable)</h5>
                                <textarea class="w-full p-3 text-sm border rounded-lg bg-slate-50 font-mono text-slate-700 h-24 resize-none" id="datos-supabase">${s.datos_supabase}</textarea>
                            </div>
                        </div>
                    `;
                }
            }


            return `
            <div class="stage-card relative pl-14 pb-12 group" id="stage-${s.code}">
                <div class="stage-connector"></div>
                <div class="absolute left-0 top-0 w-14 h-14 flex items-center justify-center">
                    <div class="w-10 h-10 rounded-full bg-${s.color}-100 border-2 border-${s.color}-500 text-${s.color}-700 font-bold flex items-center justify-center shadow-sm z-10">
                        ${s.code}
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 hover:shadow-md transition-all relative">
                    <h4 class="text-lg font-bold text-slate-800">${s.title}</h4>
                    <div class="flex items-center space-x-2 mt-1 mb-2">
                        <span class="text-xs font-bold px-2 py-0.5 rounded bg-${s.color}-100 text-${s.color}-800 uppercase">Rol: ${s.role}</span>
                        <span class="text-xs font-bold px-2 py-0.5 rounded bg-orange-50 text-orange-600">KPI Objetivo: ${s.kpi}</span>
                        <span class="text-xs text-slate-500 font-medium">Tiempo M√°x:</span>
                        <input type="text" value="${s.time_limit}" class="text-xs p-1 rounded border w-32 text-center bg-slate-50" id="time-limit-${s.code}">
                    </div>
                    
                    ${metadataBlock}

                    <div class="mt-4 space-y-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase">üì¢ System Prompt Base (Editable)</label>
                        <textarea class="w-full p-3 text-sm border rounded-lg bg-slate-50 focus:ring-2 focus:ring-rag-blue outline-none font-mono text-slate-700 h-20 resize-none leading-relaxed" id="prompt-${s.code}">${s.prompt}</textarea>

                        <!-- Extra Contextual Content RENDERED HERE -->
                        ${extraContent}
                        
                        <div class="mt-6 border-t pt-4">
                            <div class="flex justify-between items-center">
                                <h5 class="text-sm font-bold text-slate-700">Flujo Conversacional de Camino Cr√≠tico</h5>
                                <button class="text-xs bg-rag-blue text-white px-3 py-1 rounded hover:bg-cyan-600 no-print btn-visible-add" onclick="addQAStep('${s.code}', '', '', '', '')">
                                    <i class="fa-solid fa-plus mr-1"></i> A√±adir Paso
                                </button>
                            </div>
                            <div id="qa-container-${s.code}">
                                <!-- Q&A Steps will be added here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }).join('');

        // Re-render Q&A steps after generating stage structure
        stages.forEach(s => {
            s.qa_steps.forEach(step => {
                const entitiesStr = Array.isArray(step.entities_to_capture) ? step.entities_to_capture.join(', ') : step.entities_to_capture || '';
                addQAStep(s.code, step.q, step.a, entitiesStr, step.cp_trigger);
            });
        });
    }

    // --- Nuevo RAG / Wizard Logic ---
    let nr_currentStep = 1;

    function openNuevoRAG() {
        document.getElementById('nuevo-rag-modal').classList.remove('hidden');
        nr_currentStep = 1;
        showWizardStep(nr_currentStep);
    }

    function closeNuevoRAG() {
        document.getElementById('nuevo-rag-modal').classList.add('hidden');
    }

    function showWizardStep(n) {
        document.querySelectorAll('#nuevo-rag-steps .step').forEach(el => el.classList.add('hidden'));
        const el = document.querySelector(`#nuevo-rag-steps .step[data-step='${n}']`);
        if (el) el.classList.remove('hidden');
        // prev/next visibility
        document.getElementById('nr-prev').classList.toggle('hidden', n===1);
        document.getElementById('nr-next').innerText = (n===3) ? 'Finalizar' : 'Siguiente';
    }

    function nextWizardStep() {
        if (nr_currentStep === 1) {
            const user = document.getElementById('nr_user').value.trim();
            const project = document.getElementById('nr_project').value.trim();
            if (!user || !project) {
                alert('Por favor ingrese Usuario y Proyecto para continuar.');
                return;
            }
            // save to global (temporary)
            window._nuevoRAG = { user: user, project: project };
        }
        if (nr_currentStep < 3) nr_currentStep++;
        else { finishWizard(false); return; }
        showWizardStep(nr_currentStep);
    }

    function prevWizardStep() {
        if (nr_currentStep > 1) nr_currentStep--;
        showWizardStep(nr_currentStep);
    }

    function finishWizard(skipConfirm) {
        // If skipped, allow still to set basic user if present
        if (!window._nuevoRAG) {
            const u = document.getElementById('nr_user').value.trim();
            const p = document.getElementById('nr_project').value.trim();
            if (u && p) window._nuevoRAG = { user: u, project: p };
        }
        if (!window._nuevoRAG) {
            if (!skipConfirm) { alert('No se guard√≥ la informaci√≥n del usuario.'); return; }
        }
        // Persist into page state
        if (window._nuevoRAG) {
            document.getElementById('clientName').value = window._nuevoRAG.project;
            document.getElementById('agentName').value = window._nuevoRAG.user;
        }
        enableAllInteractiveFields();
        closeNuevoRAG();
        // small toast
        console.info('Nuevo RAG iniciado por', window._nuevoRAG);
    }

    // Disable/Enable all interactive fields to force identification first
    function disableAllInteractiveFields() {
        const selectors = 'input, textarea, select, button';
        document.querySelectorAll(selectors).forEach(el => {
            // keep Nuevo RAG and nav buttons enabled
            if (el.id === 'btn-nuevo-rag' || el.closest('#nuevo-rag-modal') || el.classList.contains('nav-btn') || el.onclick && String(el.onclick).includes('showSection')) {
                return;
            }
            // allow section nav buttons
            if (el.classList && el.classList.contains('nav-btn')) return;
            // allow JSON download and print
            if (el.onclick && (String(el.onclick).includes('downloadJSON') || String(el.onclick).includes('window.print'))) return;
            // Mark disabled visually and set disabled
            try { el.dataset._wasDisabled = el.disabled ? '1' : '0'; el.disabled = true; }
            catch(e){}
        });
    }

    function enableAllInteractiveFields() {
        document.querySelectorAll('input, textarea, select, button').forEach(el => {
            if (el.id === 'btn-nuevo-rag' || el.closest('#nuevo-rag-modal')) return;
            try { el.disabled = false; } catch(e){}
        });
    }

    // Function to add a new generic stage
    function addStage() {
        const newStageCode = `E${stages.length + 1}`;
        stages.push({
            id: stages.length + 1,
            code: newStageCode,
            title: `Nueva Etapa ${newStageCode}`,
            role: "Nuevo Rol",
            color: "red",
            kpi: "Nuevo Hito (Score: 0)",
            time_limit: "N/A", // Default for new stage
            scope: "N/A",
            objective: "N/A",
            database: "Supabase",
            prompt: `Define el objetivo de la etapa ${newStageCode}.`,
            qa_steps: [
                { q: "¬øCu√°l es tu pregunta principal en esta etapa?", a: "Respuesta de ejemplo", entities_to_capture: [], cp_trigger: "N/A" }
            ]
            ,
            custom_fields: []
        });
        renderFlow();
        // Optional: Scroll to the newly added stage
        setTimeout(() => {
            document.getElementById(`stage-${newStageCode}`).scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }


    // Function to render the Entities table (Dynamically populated)
    function renderEntities() {
        const tbodyEnt = document.querySelector('#entitiesTable tbody');
        tbodyEnt.innerHTML = entities.map((e, index) => `
            <tr>
                <td class="p-3 border-b"><input type="text" value="${e.key}" class="w-full bg-transparent outline-none font-mono text-blue-600"></td>
                <td class="p-3 border-b"><select class="bg-transparent"><option ${e.type=='String'?'selected':''}>String</option><option ${e.type=='Number'?'selected':''}>Number</option><option ${e.type=='Date'?'selected':''}>Date</option><option ${e.type=='NumberRange'?'selected':''}>NumberRange</option></select></td>
                <td class="p-3 border-b"><input type="text" value="${e.validation}" class="w-full bg-transparent outline-none text-sm"></td>
                <td class="p-3 border-b text-center"><input type="number" value="${e.score}" class="w-16 bg-blue-50 text-blue-700 text-center rounded px-2 font-bold"></td>
                <td class="p-3 border-b"><input type="text" value="${e.required_in}" class="w-16 bg-slate-100 rounded px-2 text-center"></td>
                <td class="p-3 border-b"><button class="text-red-400 hover:text-red-600 no-print btn-visible-remove" onclick="this.closest('tr').remove()">√ó</button></td>
            </tr>
        `).join('');
    }

    // Function to render the RAG Sources table (Dynamically populated)
    function renderSources() {
        const tbodySrc = document.querySelector('#sourcesTable tbody');
        tbodySrc.innerHTML = sources.map((s, index) => `
            <tr>
                <td class="p-3 border-b"><input type="text" value="${s.name}" class="w-full bg-transparent outline-none font-bold"></td>
                <td class="p-3 border-b"><input type="text" value="${s.type} / ${s.url}" class="w-full bg-transparent outline-none text-sm font-mono"></td>
                <td class="p-3 border-b"><select class="bg-slate-50 rounded"><option ${s.priority=='Alta'?'selected':''}>Alta</option><option ${s.priority=='Media'?'selected':''}>Media</option><option ${s.priority=='Baja'?'selected':''}>Baja</option></select></td>
                <td class="p-3 border-b"><button class="text-red-400 hover:text-red-600 no-print btn-visible-remove" onclick="this.closest('tr').remove()">√ó</button></td>
            </tr>
        `).join('');
    }

    // Function to render the Global Checkpoints table (Dynamically populated)
    function renderScoring() {
        const tbodyScore = document.getElementById('scoring-tbody');
        tbodyScore.innerHTML = checkpoints.map((cp, index) => `
            <tr class="hover:bg-slate-50 border-b border-slate-100">
                <td class="p-4 font-mono text-xs font-bold text-slate-500"><input type="text" value="${cp.id}" class="w-10 bg-slate-100 text-center rounded"></td>
                <td class="p-4 text-slate-700 font-medium"><input type="text" value="${cp.desc}" class="w-full bg-transparent"></td>
                <td class="p-4"><input type="text" value="${cp.stage}" class="w-16 bg-slate-100 text-center rounded"></td>
                <td class="p-4 text-right"><input type="number" value="${cp.score}" class="w-16 bg-blue-50 text-blue-700 text-center rounded font-bold"></td>
                <td class="p-4"><button class="text-red-400 hover:text-red-600 no-print btn-visible-remove" onclick="this.closest('tr').remove()">√ó</button></td>
            </tr>
        `).join('');
    }

    // Function to render the Q&A Library table (Dynamically populated)
    function renderQALibrary() {
        const tbodyQA = document.querySelector('#qaLibraryTable tbody');
        tbodyQA.innerHTML = qaLibrary.map((qa, index) => `
            <tr>
                <td class="p-3 border-b"><input type="text" value="${qa.q}" class="w-full bg-transparent outline-none font-bold"></td>
                <td class="p-3 border-b"><input type="text" value="${qa.a}" class="w-full bg-transparent outline-none text-sm"></td>
                <td class="p-3 border-b text-center"><input type="number" value="${qa.score}" class="w-16 bg-blue-50 text-blue-700 text-center rounded px-2 font-bold"></td>
                <td class="p-3 border-b">
                    <select class="bg-slate-50 rounded">
                        <option value="E1" ${qa.stage=='E1'?'selected':''}>E1 - Validador</option>
                        <option value="E2" ${qa.stage=='E2'?'selected':''}>E2 - Consultor</option>
                        <option value="E3" ${qa.stage=='E3'?'selected':''}>E3 - Agendador</option>
                        <option value="GLOBAL" ${qa.stage=='GLOBAL'?'selected':''}>GLOBAL</option>
                    </select>
                </td>
                <td class="p-3 border-b"><button class="text-red-400 hover:text-red-600 no-print btn-visible-remove" onclick="this.closest('tr').remove()">√ó</button></td>
            </tr>
        `).join('');
    }

    // --- Dynamic Add Row Functions (Ensure full rendering on addition) ---
    function addEntityRow() { entities.push({ key: `new_entity_${Date.now()}`, type: "String", validation: "", score: 0, required_in: "" }); renderEntities(); }
    function addSourceRow() { sources.push({ name: "Nueva Fuente", type: "URL", url: "", priority: "Media" }); renderSources(); }
    function addScoringRow() { checkpoints.push({ id: `CP${document.querySelectorAll('#scoring-tbody tr').length + 1}`, desc: "Nuevo Criterio de Scoring", stage: "E1", score: 0 }); renderScoring(); }
    function addQALibraryRow() { qaLibrary.push({ q: "Nueva pregunta de la librer√≠a", a: "Respuesta esperada", score: 0, stage: "E1" }); renderQALibrary(); }

    
    // Helper to scrape data from a dynamic table
    function scrapeEditableTable(tableId, columnKeys) {
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        return Array.from(rows).map(row => {
            const inputs = row.querySelectorAll('input');
            const data = {};
            columnKeys.forEach((key, index) => {
                data[key] = inputs[index] ? inputs[index].value : '';
            });
            return data;
        });
    }

    // --- NAVIGATION AND EXPORT ---
    function showSection(id, event) {
        document.querySelectorAll('.section-panel').forEach(el => el.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('tab-active');
            btn.classList.add('tab-inactive');
        });
        if(event && event.currentTarget){
            event.currentTarget.classList.remove('tab-inactive');
            event.currentTarget.classList.add('tab-active');
        } else {
             // Handle initial load or direct call without event
            const btn = document.querySelector(`.nav-btn[onclick*="${id}"]`);
            if(btn) {
                btn.classList.remove('tab-inactive');
                btn.classList.add('tab-active');
            }
        }

        const titles = {
            'dashboard': 'Resumen & Persona',
            'flow': 'Flujo Q&A Detallado',
            'entities': 'Mapeo de Entidades (Scoring)',
            'rag-config': 'Base de Conocimiento',
            'qa-library': 'Librer√≠a Maestra Q&A',
            'scoring': 'Scoring Global (CPs)',
            'export': 'Exportaci√≥n T√©cnica'
        };
        document.getElementById('page-title').innerText = titles[id];
        document.getElementById('page-subtitle').innerText = "Configuraci√≥n espec√≠fica para " + titles[id].toLowerCase();
        
        if(id === 'export') updateJsonPreview();
    }

    function updateJsonPreview() {
        // Helper to scrape static table data
        const scrapeTable = (tableId, mapFn) => Array.from(document.querySelectorAll(`#${tableId} tbody tr`)).map(mapFn);

        const scrapedEntities = scrapeTable('entitiesTable', tr => ({
            key: tr.querySelectorAll('input')[0].value,
            type: tr.querySelector('select').value,
            validation: tr.querySelectorAll('input')[1].value,
            score: parseInt(tr.querySelectorAll('input')[2].value) || 0,
            required_in: tr.querySelectorAll('input')[3].value
        }));

        const scrapedCheckpoints = scrapeTable('scoringTable', tr => ({
            id: tr.querySelectorAll('input')[0].value,
            desc: tr.querySelectorAll('input')[1].value,
            stage: tr.querySelectorAll('input')[2].value,
            score: parseInt(tr.querySelectorAll('input')[3].value) || 0
        }));

        const scrapedQALibrary = scrapeTable('qaLibraryTable', tr => ({
            question: tr.querySelectorAll('input')[0].value,
            expected_answer: tr.querySelectorAll('input')[1].value,
            score_on_success: parseInt(tr.querySelectorAll('input')[2].value) || 0,
            assigned_stage: tr.querySelector('select').value,
        }));

        const scrapedSources = scrapeTable('sourcesTable', tr => ({
            name: tr.querySelectorAll('input')[0].value,
            type_url: tr.querySelectorAll('input')[1].value,
            priority: tr.querySelector('select').value
        }));
        
        const scrapedProductKnowledge = scrapeEditableTable('product-knowledge-table', ['model', 'autonomia', 'potencia', 'usp', 'perfil']);


        const scrapedStages = stages.map(s => {
            const qaSteps = Array.from(document.querySelectorAll(`#qa-container-${s.code} .qa-step-card`)).map(card => ({
                question: card.querySelectorAll('input')[0].value,
                expected_answer: card.querySelectorAll('input')[1].value,
                entities_to_capture: card.querySelectorAll('input')[2].value.split(',').map(e => e.trim()).filter(e => e !== ''),
                cp_trigger: card.querySelectorAll('input')[3].value
            }));

            const stageData = {
                code: s.code,
                role: s.role,
                kpi_objective: s.kpi, 
                // Capture the time limit field
                time_limit: document.getElementById(`time-limit-${s.code}`) ? document.getElementById(`time-limit-${s.code}`).value : s.time_limit,
                
                // Capture new metadata fields
                scope: document.getElementById(`scope-${s.code}`).value,
                objective: document.getElementById(`objective-${s.code}`).value,
                database: document.getElementById(`database-${s.code}`).value,

                system_prompt: document.getElementById(`prompt-${s.code}`).value,
                qa_flow: qaSteps,
            };

            // Capture all new dynamic fields
            if (s.code === 'E1' && document.getElementById(`context-notes-${s.code}`)) {
                stageData.context_notes = document.getElementById(`context-notes-${s.code}`).value;
            }

            if (s.code === 'E2') {
                if (s.rag_config) {
                    stageData.rag_settings = {
                        pre_condition: document.getElementById(`rag-precondition-${s.code}`).value,
                        strategy: document.getElementById(`rag-strategy-${s.code}`).value,
                    };
                }
                    // Capture custom fields for this stage (Section 2 dynamic fields)
                    const customInputs = Array.from(document.querySelectorAll(`#custom-fields-${s.code} .custom-field-input`)).map(input => {
                        const parts = input.id.split('-');
                        const key = parts.slice(2).join('-');
                        return { key: key, value: input.value };
                    });
                    if (customInputs.length) stageData.custom_fields = customInputs;
                stageData.context_notes = document.getElementById(`context-notes-${s.code}`).value;
                stageData.formula_humana = scrapeEditableTable('formula-humana-table', ['elemento', 'que_es', 'ejemplo']);
                stageData.ejemplo_comparacion = document.getElementById('ejemplo-comparacion').value;
                stageData.senales_compra = scrapeEditableTable('senales-compra-table', ['senal', 'nivel']);
                stageData.scripts_transicion = document.getElementById('scripts-transicion').value;
                
            }

            if (s.code === 'E3') {
                stageData.context_notes = document.getElementById(`context-notes-${s.code}`).value;
                stageData.confirmacion_final_template = document.getElementById('confirmacion-final-template').value;
                stageData.datos_supabase = document.getElementById('datos-supabase').value;
            }
            
            return stageData;
        });

        const config = {
            project: document.getElementById('clientName').value,
            agent_name: document.getElementById('agentName').value,
            nuevo_rag: window._nuevoRAG || null,
            version: "8.0-RAG-Scoring-Master",
            last_updated: new Date().toISOString(),
            system_prompt_base: document.getElementById('basePrompt').value,
            
            // SCORING MODULE
            scoring_module: {
                logic: "TOTAL = SUM(Entity Scores) + SUM(Response Scores) + SUM(Checkpoint Scores)",
                entity_scoring: scrapedEntities, 
                response_scoring_library: scrapedQALibrary, 
                global_checkpoints: scrapedCheckpoints, 
            },

            // FLOW MODULE
            journey_stages: scrapedStages,

            // RAG MODULE
            rag_config: {
                rag_system_prompt: document.getElementById('ragPrompt').value,
                knowledge_sources: scrapedSources,
                product_knowledge_reference: scrapedProductKnowledge // Store the editable product table here
            }
        };

        document.getElementById('json-preview').textContent = JSON.stringify(config, null, 2);
        return config;
    }

    function downloadJSON() {
        const data = updateJsonPreview();
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = `rag_agent_config_${document.getElementById('clientName').value.replace(/\s+/g, '_')}_v8.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
    }

    // --- INIT ---
    window.onload = function() {
        // Set default values for quick start
        document.getElementById('basePrompt').value = `Eres un Agente Setter profesional. Tu misi√≥n es calificar al lead (E1/E2) y agendar una cita (E3). NO VENDES.`;
        document.getElementById('ragPrompt').value = `Instrucciones para el motor de respuestas. Si no encuentras informaci√≥n sobre un precio, di que deben consultar el sitio web, NO inventes el dato.`;
        document.getElementById('clientName').value = "Venta de autos el√©ctricos BYD";
        document.getElementById('agentName').value = "Sof√≠a, Agente Setter";
        
        renderFlow();
        renderEntities();
        renderSources();
        renderScoring();
        renderQALibrary();
        // Disable all interactive fields until user starts Nuevo RAG
        disableAllInteractiveFields();
        showSection('flow'); // Start on the detailed flow section
    }
</script>

</body>
</html>